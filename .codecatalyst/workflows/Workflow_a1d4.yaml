Name: TerraformDeploy
SchemaVersion: "1.0"

# Trigger automÃ¡tico en push a main
Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  # ValidaciÃ³n de Terraform
  TerraformValidate:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            terraform --version
            terraform init
            terraform validate
            echo "âœ… Terraform validation passed"
    Environment:
      Name: production
      Connections:
        - Name: default_account
          Role: CodeCatalystWorkflowDevelopmentRole-spacename

  # Plan de Terraform
  TerraformPlan:
    Identifier: aws/build@v1
    DependsOn:
      - TerraformValidate
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            terraform init
            terraform plan -out=tfplan
            echo "ðŸ“‹ Terraform plan completed"
    Environment:
      Name: production
      Connections:
        - Name: default_account
          Role: CodeCatalystWorkflowDevelopmentRole-spacename
    Outputs:
      Artifacts:
        - Name: terraform-plan
          Files:
            - "tfplan"
            - ".terraform/**"

  # Apply de Terraform
  TerraformApply:
    Identifier: aws/build@v1
    DependsOn:
      - TerraformPlan
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - terraform-plan
    Configuration:
      Steps:
        - Run: |
            terraform init
            terraform apply tfplan
            echo "ðŸš€ Terraform apply completed"
    Environment:
      Name: production
      Connections:
        - Name: default_account
          Role: CodeCatalystWorkflowDevelopmentRole-spacename

