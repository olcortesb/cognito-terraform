Name: TerraformDeploy
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  TerraformPlan:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            # Instalar Terraform
            wget https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip
            unzip terraform_1.9.8_linux_amd64.zip
            chmod +x terraform
            export PATH=$PATH:$(pwd)
            ./terraform --version
        - Run: ./terraform init
        - Run: ./terraform validate
        - Run: ./terraform plan -var="environment=dev" -var="region=us-east-1"
    Outputs:
      Artifacts:
        - Name: terraform_files
          Files:
            - "terraform"
            - ".terraform/**"
            - "*.tf"
            - "*.tfstate*"
    Environment:
      Name: dev
      Connections:
        - Name: olcortesb-account
          Role: CodeCatalystWorkflowDevelopmentRole-olcortesb

  TerraformApply:
    Identifier: aws/build@v1
    DependsOn:
      - TerraformPlan
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - terraform_files
    Configuration:
      Steps:
        - Run: chmod +x terraform
        - Run: ./terraform apply -var="environment=dev" -var="region=us-east-1" -auto-approve
    Environment:
      Name: dev
      Connections:
        - Name: olcortesb-account
          Role: CodeCatalystWorkflowDevelopmentRole-olcortesb