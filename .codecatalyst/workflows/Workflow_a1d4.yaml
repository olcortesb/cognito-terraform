Name: TerraformDeploy
SchemaVersion: "1.0"

# Trigger automÃ¡tico en push a main
Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  # ValidaciÃ³n de Terraform
  Terraform_Validate:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            terraform --version
            terraform init
            terraform validate
            echo "âœ… Terraform validation passed"
    Environment:
      Name: dev
      Connections:
        - Name: olcortesb-account
          Role: CodeCatalystWorkflowDevelopmentRole-olcortesb

  # Plan de Terraform
  Terraform_Plan:
    Identifier: aws/build@v1
    DependsOn:
      - Terraform_Validate
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            terraform init
            terraform plan -out=tfplan
            echo "ðŸ“‹ Terraform plan completed"
    Environment:
      Name: dev
      Connections:
        - Name: olcortesb-account
          Role: CodeCatalystWorkflowDevelopmentRole-olcortesb
    Outputs:
      Artifacts:
        - Name: terraform_plan
          Files:
            - "tfplan"
            - ".terraform/**"

  # Apply de Terraform
  Terraform_Apply:
    Identifier: aws/build@v1
    DependsOn:
      - Terraform_Plan
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - terraform_plan
    Configuration:
      Steps:
        - Run: |
            terraform init
            terraform apply tfplan
            echo "ðŸš€ Terraform apply completed"
    Environment:
      Name: dev
      Connections:
        - Name: olcortesb-account
          Role: CodeCatalystWorkflowDevelopmentRole-olcortesb